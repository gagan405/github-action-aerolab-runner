name: "Run Aerolab with Commands"

on:
  workflow_call:
    inputs:
      version:
        description: "Aerolab release version (if omitted, latest)"
        required: false
        type: string
      nodes:
        description: "Number of cluster nodes"
        required: false
        type: number
        default: 3
      cluster_name:
        description: "Name of the cluster"
        required: false
        type: string
        default: "ce"
      aerospike_version:
        description: "Aerolab/Aerospike version"
        required: false
        type: string
        default: "8.1.0.1"

jobs:
  run-aerolab:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:dind
        options: >-
          --privileged
          --env DOCKER_TLS_CERTDIR=

    env:
      DOCKER_HOST: tcp://localhost:2375
      DOCKER_TLS_CERTDIR: ""

    steps:
      - name: Checkout (needed if calling from repo)
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Download Aerolab .deb from GitHub
        id: download
        run: |
          if [ -z "${{ inputs.version }}" ]; then
            echo "Fetching latest release..."
            URL=$(curl -s https://api.github.com/repos/aerospike/aerolab/releases/latest \
                 | jq -r '.assets[] | select(.name | endswith(".deb")).browser_download_url')
          else
            echo "Fetching release tag: ${{ inputs.version }}"
            URL=$(curl -s https://api.github.com/repos/aerospike/aerolab/releases/tags/${{ inputs.version }} \
                 | jq -r '.assets[] | select(.name | endswith(".deb")).browser_download_url')
          fi
          echo "Downloading $URL"
          curl -L -o aerolab.deb "$URL"

      - name: Build Aerolab Docker image
        run: |
          cat > Dockerfile <<'EOF'
          FROM ubuntu:24.04
          WORKDIR /aerolab
          COPY aerolab.deb /tmp/
          RUN apt-get update && \
              apt-get install -y /tmp/aerolab.deb && \
              rm -rf /tmp/aerolab.deb /var/lib/apt/lists/*
          ENTRYPOINT ["aerolab"]
          EOF
          docker build -t aerolab-runner:latest .

      - name: Run Aerolab commands
        run: |
          docker run --privileged --rm aerolab-runner:latest config backend -t docker
          docker run --privileged --rm aerolab-runner:latest cluster create \
            -v "${{ inputs.aerospike_version }}" \
            -c "${{ inputs.nodes }}" \
            -n "${{ inputs.cluster_name }}"
