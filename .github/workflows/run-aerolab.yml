name: "Run Aerolab with Commands"

on:
  workflow_call:
    inputs:
      aerospike_version:
        description: "Aerospike version for cluster creation"
        required: false
        type: string
        default: "8.1.0.1"
      nodes:
        description: "Number of cluster nodes"
        required: false
        type: string
        default: "3"
      cluster_name:
        description: "Cluster name"
        required: false
        type: string
        default: "ce"

jobs:
  run-aerolab:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: Download Aerolab .deb
        run: |
          echo "Downloading Aerolab 7.9.0 (amd64)"
          curl -L -o aerolab.deb https://github.com/aerospike/aerolab/releases/download/7.9.0/aerolab-linux-amd64-7.9.0.deb

      - name: Install Aerolab
        run: |
          sudo dpkg -i aerolab.deb
          sudo apt-get install -f -y  # in case of missing dependencies

      - name: Prepare Aerolab home
        run: |
          mkdir -p /tmp/aerolab-home
          export AEROLAB_HOME=/tmp/aerolab-home

      - name: Configure Aerolab backend
        run: |
          export AEROLAB_HOME=/tmp/aerolab-home
          aerolab config backend -t docker

      - name: Create Aerospike cluster
        run: |
          export AEROLAB_HOME=/tmp/aerolab-home
          aerolab cluster create \
            -v "${{ inputs.aerospike_version }}" \
            -c "${{ inputs.nodes }}" \
            -n "${{ inputs.cluster_name }}"
