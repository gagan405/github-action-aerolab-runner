name: "Run Aerolab with Commands"

on:
  workflow_call:
    inputs:
      aerospike_version:
        description: "Aerospike version for cluster creation"
        required: false
        type: string
        default: "8.1.0.1"
      nodes:
        description: "Number of cluster nodes"
        required: false
        type: string
        default: "3"
      cluster_name:
        description: "Cluster name"
        required: false
        type: string
        default: "ce"

jobs:
  run-aerolab:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Download Aerolab .deb
        run: curl -L -o aerolab.deb https://github.com/aerospike/aerolab/releases/download/7.9.0/aerolab-linux-amd64-7.9.0.deb

      - name: Build Aerolab Docker image
        run: |
          cat > Dockerfile <<'EOF'
          FROM ubuntu:24.04
          WORKDIR /aerolab
          COPY aerolab.deb /tmp/
          RUN apt-get update && \
              apt-get install -y /tmp/aerolab.deb && \
              rm -rf /tmp/aerolab.deb /var/lib/apt/lists/*
          ENTRYPOINT ["aerolab"]
          EOF

          docker build -t aerolab-runner:latest .

      - name: Run Aerolab cluster
        run: |
          docker run --privileged --rm aerolab-runner:latest config backend -t docker
          docker run --privileged --rm aerolab-runner:latest cluster create \
            -v "8.1.0.1" -c "3" -n "ce"
